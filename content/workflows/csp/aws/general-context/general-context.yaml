schema: 1
type: general-context

id: general-context-aws
name: General context + tag-based risk for AWS resources

csp: aws

filters:
  - match-type: all
    rules:
      - .csp=="aws" and .canonicalId and .resourceType != "AwsAccount" # for alerts belonging to an account, the resource type is set to "AwsAccount" by security hub
      #todo: try to get tags from aws org for the account

steps:
  - id: getTags
    uses: GetTags
    with:
      - name: arn
        value: .canonicalId
      - name: region
        value: .region

risk-config:
  default-risk: ""
  rules:
    - name: dev enviornment risk is low
      condition: |-
        .getTags | any( select(.key | test("env" ; "ix")) | select(.value | test("dev" ; "ix")))
      risk: low

    - name: prod enviornment risk is high
      condition: |-
        .getTags | any( select(.key | test("env" ; "ix")) | select(.value | test("prod" ; "ix")))
      risk: high

output:
  - name: environment
    value: first(.getTags[] | select(.key == "env") .value)
